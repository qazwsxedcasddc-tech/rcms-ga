# Протокол Modbus RTU для радиостанций Фазан-19

Документация протокола взаимодействия с радиостанциями серии "Фазан-19" по интерфейсу RS-485.

## Общие параметры

| Параметр | Значение |
|----------|----------|
| Протокол | Modbus RTU |
| Интерфейс | RS-485 |
| CRC | CRC-16 Modbus (Little Endian) |
| Таймаут ответа | 2000 мс |
| Макс. длина линии | 1200 м |

## Параметры последовательного порта

| Параметр | Значение |
|----------|----------|
| Скорость | 9600 бод (уточнить в РЭ) |
| Биты данных | 8 |
| Стоп-биты | 1 |
| Чётность | None |

## Карта регистров Modbus

### Holding Registers (чтение/запись)

| Адрес | Имя | Размер | Описание |
|-------|-----|--------|----------|
| 0x00 | CW1 | 16 бит | Наработка (часы), старшее слово |
| 0x01 | CW2 | 16 бит | Наработка (часы), младшее слово |
| 0x02 | Cntr | 16 бит | Регистр запросов |
| 0x03 | MR1 | 16 бит | Регистр режимов 1 |
| 0x04 | MR2 | 16 бит | Регистр режимов 2 |
| 0x05 | FrRS | 16 бит | Рабочая частота + коэффициент KF |

### Регистр MR1 (0x03) — биты режимов

| Бит | Описание |
|-----|----------|
| 7 | Подавитель шума (ПШ): 1=вкл, 0=выкл |
| ... | (требуется уточнение из РЭ) |

### Input Registers (только чтение)

| Адрес | Имя | Описание |
|-------|-----|----------|
| 0x09 | AD0 | АЦП канал 0 |
| 0x0A | AD1 | АЦП канал 1 |
| 0x0B | AD2 | АЦП канал 2 |
| 0x0C | AD3 | АЦП канал 3 |
| 0x0D | AD4 | АЦП канал 4 |
| 0x0E | AD5 | АЦП канал 5 |
| 0x0F | AD6 | АЦП канал 6 |
| 0x10 | AD7 | АЦП канал 7 |
| 0x11 | ... | ... |
| 0x16 | DV1 | Регистр ошибок 1 |
| 0x17 | DV2 | Регистр ошибок 2 |
| 0x18 | DV3 | Регистр ошибок 3 |
| 0x19 | DV4 | Регистр ошибок 4 |

## Кодирование частоты

### Параметры

| Параметр | Значение |
|----------|----------|
| Базовая частота | 100 МГц |
| Шаг сетки | 8333.33333 Гц (8.3(3) кГц) |
| Диапазон | 118.000 - 136.975 МГц (трассовый) |

### Формула расчёта

```
Для записи:
  diff = (freq_MHz - 100) * 1000000
  f12 = round(diff / 8333.33333)    // 13 бит
  FrRS = (KF << 13) | f12           // KF = 2 бита

Для чтения:
  f12 = FrRS & 0x1FFF               // младшие 13 бит
  KF = (FrRS >> 13) & 0x03          // старшие 2 бита
  freq_MHz = 100 + (f12 * 8333.33333) / 1000000
```

### Коэффициент KF (2 бита)

| KF | Описание |
|----|----------|
| 00 | Без смещения (шаг 25 кГц) |
| 01 | Смещение +8.33 кГц |
| 10 | Смещение +16.67 кГц |
| 11 | (уточнить в РЭ) |

### Пример: частота 121.5 МГц

```
diff = (121.5 - 100) * 1000000 = 21500000
f12 = round(21500000 / 8333.33333) = 2580
KF = 0 (без смещения)
FrRS = (0 << 13) | 2580 = 2580 = 0x0A14
```

### Пример: частота 133.5 МГц

```
diff = (133.5 - 100) * 1000000 = 33500000
f12 = round(33500000 / 8333.33333) = 4020
FrRS = 4020 = 0x0FB4
```

## Команды Modbus

### Чтение регистров (функция 0x03)

Чтение 28 регистров начиная с адреса 0x00:

```
Запрос:  [ADDR] 03 00 00 00 1C [CRC16_LO] [CRC16_HI]
Ответ:   [ADDR] 03 38 [56 байт данных] [CRC16_LO] [CRC16_HI]
```

### Запись одного регистра (функция 0x06)

```
Запрос:  [ADDR] 06 [REG_HI] [REG_LO] [VAL_HI] [VAL_LO] [CRC16_LO] [CRC16_HI]
Ответ:   (эхо запроса)
```

### Запись нескольких регистров (функция 0x10)

```
Запрос:  [ADDR] 10 [REG_HI] [REG_LO] 00 01 02 [VAL_HI] [VAL_LO] [CRC16_LO] [CRC16_HI]
```

### Чтение идентификатора (функция 0x11)

```
Запрос:  [ADDR] 11 [CRC16_LO] [CRC16_HI]
Ответ:   [ADDR] 11 [данные ID] [CRC16_LO] [CRC16_HI]
```

## CRC-16 Modbus

Полином: 0x8005 (reflected: 0xA001)
Начальное значение: 0xFFFF
Порядок байт в пакете: Little Endian (младший байт первый)

### Пример на C++

```cpp
uint16_t crc16_modbus(const uint8_t* data, size_t len) {
    uint16_t crc = 0xFFFF;
    for (size_t i = 0; i < len; i++) {
        crc ^= data[i];
        for (int j = 0; j < 8; j++) {
            if (crc & 0x0001) {
                crc = (crc >> 1) ^ 0xA001;
            } else {
                crc >>= 1;
            }
        }
    }
    return crc;
}
```

## Коды ошибок ответа

| Код | Описание |
|-----|----------|
| 0x02 | Недопустимый адрес данных |
| 0x03 | Недопустимое значение данных |
| 0x06 | Устройство занято |
| 0x09 | (уточнить) |

## Аппаратное подключение

### Рекомендуемые конвертеры

| Тип | Применение |
|-----|------------|
| USB-RS485 | Локальное подключение (до 1200 м) |
| RS232-RS485 | Самый стабильный вариант |
| RS485-LAN (MOXA) | Удалённые объекты через IP |
| Болид С2000-Ethernet | LAN/RS485 с UDP протоколом |

### Схема кабеля

См. файл `stuff/Cable_scheme_fazan_moxa.jpg` в репозитории drudrum/fazan_19P50.

## Источники

1. Приложение А технического описания "Фазан-19" (РЭ)
2. https://github.com/drudrum/fazan_19P50 — референсная реализация на JavaScript
3. Форум ЭРТОС — обсуждение практического опыта
