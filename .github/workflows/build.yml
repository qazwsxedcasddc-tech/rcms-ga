name: Build & Test

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          qtbase5-dev \
          libqt5serialport5-dev \
          libspdlog-dev \
          nlohmann-json3-dev \
          libsqlite3-dev \
          libgtest-dev \
          libxcb-xinerama0

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --parallel $(nproc)

    - name: Run unit tests
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Upload Linux binary
      uses: actions/upload-artifact@v4
      with:
        name: rcms-ga-linux-x64
        path: build/rcms-ga
        if-no-files-found: warn

  # Windows сборка
  build-windows:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install aqtinstall
      run: pip install aqtinstall

    - name: Install Qt 5.15.2
      run: |
        aqt install-qt windows desktop 5.15.2 win64_msvc2019_64 -m qtserialport --outputdir ${{ github.workspace }}/Qt
      shell: bash

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install vcpkg dependencies
      run: |
        vcpkg install spdlog:x64-windows nlohmann-json:x64-windows sqlite3:x64-windows
      env:
        VCPKG_DEFAULT_TRIPLET: x64-windows

    - name: Configure CMake
      run: |
        $env:CMAKE_PREFIX_PATH = "${{ github.workspace }}/Qt/5.15.2/msvc2019_64"
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_TESTS=OFF `
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/Qt/5.15.2/msvc2019_64" `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"

    - name: Build
      run: cmake --build build --config Release

    - name: Deploy Qt DLLs
      run: |
        mkdir deploy
        copy build\Release\rcms-ga.exe deploy\
        $env:PATH = "${{ github.workspace }}/Qt/5.15.2/msvc2019_64/bin;$env:PATH"
        windeployqt --release --no-translations --no-opengl-sw deploy\rcms-ga.exe

    - name: Upload Windows binary
      uses: actions/upload-artifact@v4
      with:
        name: rcms-ga-windows-x64
        path: deploy/
        if-no-files-found: warn

  # Статический анализ кода
  static-analysis:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance \
                 --suppress=missingIncludeSystem \
                 --error-exitcode=0 \
                 --inline-suppr \
                 -I src \
                 src/

  # Проверка форматирования (опционально)
  format-check:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check line endings
      run: |
        if git grep -l $'\r' -- '*.cpp' '*.h'; then
          echo "Found Windows line endings in source files!"
          exit 1
        fi
        echo "Line endings OK"
